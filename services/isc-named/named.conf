# named.conf(5)
# named(8)
# 
# Конфигурационный файл DNS сервера ISC BIND.
# 

# Используйте утилиту named-checkconf(8) для проверки правильности синтаксиса
# конфигурационного файла. В случае, если named(8) запускается в chroot, -
# указывайте при проверке путь до chroot через флаг '-t':
# named-checkconf -t /path-to/chroot in-chroot/named.conf


# ------------------------------------------------------------------------------
# СПИСКИ КОНТОРОЛЯ ДОСТУПА

# Сеть локальной зоны DNS.
acl "local_net" { 192.168.1/24; };

# Сеть VPN.
acl "vpn_net" { 192.168.10/24; };

# Сеть кольцевого интерфейса.
acl "loopback_net" { 127/8; };

# Список прослушиваемых интерфейсов.
acl "interfaces" { 192.168.1.251; 127.0.0.1; };

# Список вторичных серверов DNS.
acl "slaves" { 192.168.1.254; };

# Список используемых DNS-серверов на которые идет переадресация запросов не
# относящихся к зонам, для которых named(8) является авторитетным сервером.
# acl "dns_forwarders" { 8.8.8.8; 8.8.4.4; };


# ------------------------------------------------------------------------------
# ПАРАМЕТРЫ СЕРВЕРА

# Включить файл с ключом для аутентификации rndc(8).
include "/etc/rndc.key";

# Разрешить управление через rndc(8) только для следующих интерфейсов.
# См. детальную информацию в rndc-confgen(8) и rndc.conf(5)
controls {
  
  inet 127.0.0.1 port 953
  allow { "loopback_net"; } keys { "rndc-key"; };

};

options {

  # Не возвращать версию BIND на запрос "version.bind.".
  version none;
  
  # Прослушивать указанные интерфейсы.
  listen-on { "interfaces"; };

  # Каталог, используемый named(8) для хранения своих файлов, в т.ч. файлов зон
  # кэша, статистики и пр.
  directory "/var/named";

  # Файл в который сбрасывается кэш сервера при вызове команды rndc dumpdb.
  dump-file "data/cache_dump.db";

  # Файл в который сбрасывается статистика сервера при вызове команды rndc stats.
  statistics-file "data/named_stats.txt";

  # Файл в который сбрасывается статистика использования памяти сервером при
  # завершении работы сервера.
  memstatistics-file "data/named_mem_stats.txt";

  # Разрешить серверу отвечать на DNS-запросы только тех клиентов, котрые
  # находятся в указаных сетях:
  allow-query { "local_net"; "vpn_net"; "loopback_net"; };

  # Разрешить серверу отвечать на DNS-запросы только если приходят на указанные
  # сетевые интерфейсы.
  allow-query-on { "interfaces"; };

  # Включить поддержку рекурсивных запросов?
  recursion yes;

  # Разрешить рекурсивные запросы только для указанных клиентов:
  allow-recursion  { "local_net"; "vpn_net"; "loopback_net"; };

  # Разрешить рекурсивные запросы только на указанных сетевых интерфейсах:
  allow-recursion-on  { "interfaces"; };

  # Перенаправлять запросы не относящиеся к зонам, для которых сервер не
  # является авторитетным) на указанные DNS сервера.
  # forwarders { "dns_forwarders"; };

  # Максимальный размер кэша DNS.
  max-cache-size 10m;

  # Максимальное время (в сек.) кэширования положительных ответов.
  max-cache-ttl 86400;

  # Максимальное время (в сек.) кэширования отрицательных ответов.
  max-ncache-ttl 600;

  # Включить механизм DNS NOTIFY?
  # Ключевое слово "explicit" разрешает пересылку NOTIFY-сообщений только
  # серверам перечисленным в директиве allow-notify.
  notify explicit;

  # Список серверов которым будут рассылаться сообщения DNS NOTIFY:
  also-notify { 192.168.1.254; };

};


# ------------------------------------------------------------------------------
# ВЕДЕНИЕ ЖУРНАЛОВ И ОТЛАДКА

logging {

      # Стандартный журнал:
      channel file_main {

      # Записывать сообщения в указанный файл:
      # директива "versions" задает максимальное число сохраняемых файлов
      # директива "size" задает максимальный размер файла журнала
      file "/var/log/named/named-main.log" versions 5 size 1m;

      # Уровень детализации сообщений.
      severity info;

      # Записывать время?
      print-time yes;
  
      # Записывать уровень детализации?
      print-severity yes;

      # Записывать категорию сообщений?
      print-category yes;

      };

  # Записывать сообщения указанной категории в указанный канал:
  category default                     { file_main; };

};


# ------------------------------------------------------------------------------
# ОПИСАНИЕ ФАЙЛОВ ЗОН

# Локальная зона - прямое преобразование.
zone "net.local" IN {

  # Тип указывает на то, что сервер является первичным (master) или вторичным
  # (slave) для данной зоны.
  type master;

  # Расположение файла зоны относительно корневого каталога 'directory'.
  file "zones/net.local-forward.dns";

  # Разрешить передачу зоны только указанным серверам.
  allow-transfer { "slaves"; };

  # Разрешить запросы о зоне только указанным хостам:
  allow-query { "local_net"; "vpn_net"; "loopback_net"; };
};

# Локальная зона - обратное преобразование.
zone "1.168.192.in-addr.arpa" IN {
  type master;
  file "zones/net.local-reverse.dns";
  allow-transfer { "slaves"; };
  allow-query { "local_net"; "vpn_net"; "loopback_net"; };
};

# Зона для сети кольцевого интерфейса - прямое преобразование.
zone "localhost" in {
  type master;
  file "zones/localhost-forward.dns";
  allow-query { "loopback_net"; };
};

# Зона для сети кольцевого интерфейса - обратное преобразование.
zone "0.0.127.in-addr.arpa" in {
  type master;
  file "zones/localhost-reverse.dns";
  allow-query { "loopback_net"; };
};

# Файл с указателями на корневые сервера DNS.  NB: если сервер сам занимается
# разрешением имен для сторонних зон (т. е. НЕ перенаправляет подобные запросы
# другим серверам), - то в этом случае ему необходимо иметь актуальную
# информацию о корневых серверах DNS. Следует обновлять named.root раз в
# один или несколько месяцев. Актуальная версия доступна по адресу:
# http://www.internic.net/domain/named.root
zone "." in {
  type hint;
  file "zones/named.root";
};
